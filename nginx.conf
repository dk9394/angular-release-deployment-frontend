# ============================================================================
# NGINX CONFIGURATION FOR ANGULAR SPA (Single Page Application)
# ============================================================================
#
# PURPOSE:
# This nginx configuration file serves an Angular application as a static
# Single Page Application (SPA). It handles routing, caching, security headers,
# and performance optimization.
#
# MENTAL MODEL:
# Think of nginx as a waiter in a restaurant:
# - Customer asks for "/products" → Waiter checks if there's a physical file
# - No file? → Waiter serves index.html instead (Angular takes over routing)
# - Customer asks for "app.js"? → Waiter serves the actual JavaScript file
#
# WHY THIS IS NEEDED:
# - Angular uses client-side routing (/home, /about, /products)
# - These routes don't exist as physical files on the server
# - Without this config, refreshing /products would give 404 error
# - This config makes nginx serve index.html for all routes
# - Angular then reads the URL and displays the correct component
#
# ============================================================================

# Main events block - handles connection processing
events {
    # Maximum number of simultaneous connections per worker process
    # 1024 is a good default for most applications
    worker_connections 1024;
}

# HTTP server configuration block
http {
    # ========================================================================
    # MIME TYPES CONFIGURATION
    # ========================================================================
    #
    # WHAT: Tells nginx how to identify file types
    # WHY: Browsers need correct Content-Type headers to process files
    # EXAMPLE: .js files need "application/javascript" MIME type
    #
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ========================================================================
    # PERFORMANCE OPTIMIZATION
    # ========================================================================

    # sendfile: Enables efficient file transfer (kernel-level file copying)
    # WHY: Faster than reading file into memory then sending to client
    sendfile on;

    # tcp_nopush: Send headers in one packet with file content
    # WHY: Reduces number of network packets, improves performance
    tcp_nopush on;

    # keepalive_timeout: How long to keep connection open for reuse
    # WHY: Reusing connections is faster than creating new ones
    keepalive_timeout 65;

    # ========================================================================
    # GZIP COMPRESSION
    # ========================================================================
    #
    # MENTAL MODEL: Like zipping files before sending them
    # BENEFIT: 500KB JavaScript file → becomes ~120KB after gzip
    # TRADE-OFF: Slightly more CPU usage for huge bandwidth savings
    #
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;  # Compression level (1-9, 6 is balanced)
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # ========================================================================
    # SERVER BLOCK - Main Configuration
    # ========================================================================
    server {
        # Port to listen on (80 = default HTTP port)
        listen 80;

        # Server name (can be domain name or localhost)
        server_name localhost;

        # Root directory where static files are located
        # This is where nginx looks for files to serve
        # In Docker: /usr/share/nginx/html contains our Angular dist files
        root /usr/share/nginx/html;

        # Default file to serve when accessing a directory
        index index.html;

        # ====================================================================
        # LOCATION BLOCK - THE HEART OF SPA ROUTING
        # ====================================================================
        #
        # WHAT HAPPENS HERE (Request Flow):
        #
        # 1. User requests URL (e.g., http://localhost/products)
        # 2. nginx checks: "Is there a file at /products?" → NO
        # 3. nginx checks: "Is there a directory at /products/?" → NO
        # 4. nginx serves /index.html (fallback)
        # 5. Browser loads index.html → Angular app starts
        # 6. Angular router sees URL "/products" → shows ProductsComponent
        #
        # REAL-WORLD EXAMPLES:
        #
        # Request: http://localhost/
        # → try_files: $uri (/) → FOUND → Serves index.html ✓
        #
        # Request: http://localhost/main.js
        # → try_files: $uri (/main.js) → FOUND → Serves actual main.js file ✓
        #
        # Request: http://localhost/products
        # → try_files: $uri (/products) → NOT FOUND
        # → try_files: $uri/ (/products/) → NOT FOUND
        # → try_files: /index.html → FOUND → Serves index.html ✓
        # → Angular handles /products route
        #
        # Request: http://localhost/products/123
        # → try_files: $uri (/products/123) → NOT FOUND
        # → try_files: $uri/ (/products/123/) → NOT FOUND
        # → try_files: /index.html → FOUND → Serves index.html ✓
        # → Angular handles /products/123 route
        #
        # ====================================================================
        location / {
            # try_files: Try to serve in this order:
            # $uri = exact file path
            # $uri/ = directory with index.html
            # /index.html = fallback for SPA routing
            try_files $uri $uri/ /index.html;

            # ================================================================
            # SECURITY HEADERS
            # ================================================================
            #
            # WHY THESE HEADERS MATTER:
            # Without these, your app is vulnerable to XSS, clickjacking, etc.
            #

            # X-Frame-Options: Prevent your site from being embedded in iframes
            # WHY: Protects against clickjacking attacks
            add_header X-Frame-Options "SAMEORIGIN" always;

            # X-Content-Type-Options: Prevent MIME type sniffing
            # WHY: Stops browsers from interpreting files as different type
            # EXAMPLE: Prevents .txt file from being executed as JavaScript
            add_header X-Content-Type-Options "nosniff" always;

            # X-XSS-Protection: Enable browser's XSS filtering
            # WHY: Adds extra layer of protection against XSS attacks
            add_header X-XSS-Protection "1; mode=block" always;

            # Referrer-Policy: Control how much referrer info is shared
            # WHY: Privacy - don't leak full URL when user clicks external links
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        }

        # ====================================================================
        # STATIC ASSETS CACHING
        # ====================================================================
        #
        # MENTAL MODEL: Tell browser to cache files for 1 year
        # WHY: Angular uses cache-busting filenames (main.a1b2c3d4.js)
        # BENEFIT: Browser doesn't re-download files on every visit
        # SAFE: When you deploy new version, filename changes, cache busts
        #
        # EXAMPLES OF FILES MATCHED:
        # - main.a1b2c3d4.js
        # - styles.e5f6g7h8.css
        # - logo.i9j0k1l2.png
        # - font.woff2
        #
        location ~* \.(?:jpg|jpeg|gif|png|ico|svg|woff|woff2|ttf|eot|css|js)$ {
            expires 1y;  # Cache for 1 year
            add_header Cache-Control "public, immutable";
        }

        # ====================================================================
        # DISABLE CACHING FOR INDEX.HTML
        # ====================================================================
        #
        # WHY: index.html references the cache-busted files
        # PROBLEM: If index.html is cached, it might reference old files
        # SOLUTION: Never cache index.html, always fetch fresh copy
        # RESULT: index.html always has latest file references
        #
        location = /index.html {
            expires -1;  # Don't cache
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        }

        # ====================================================================
        # ERROR PAGE HANDLING
        # ====================================================================
        #
        # WHY: If something goes wrong, show user-friendly error page
        # In production, you might create custom 404.html, 500.html pages
        #
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
